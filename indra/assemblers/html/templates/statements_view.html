{% extends "indra/indra_template.html" %}

{% block scripts %}
  <!-- Toggle a hidden element -->
  <script>

    function toggler(short_name_key) {
      $("#" + short_name_key + "_group").toggle();
      let header = "#" + short_name_key + "_heading";
      $(header).show();
    }

    function getPubMedMETAxmlByPMID(pmid) {
      let params_dict = {
        'db': 'pubmed',
        'retmode': 'xml',
        'rettype': 'docsum',
        'id': pmid
      };
      return $.ajax({
        url: pubmed_fetch,
        type: "POST",
        dataType: "xml",
        data: params_dict,
      });
    }

    function pmidXML2dict(XML) {
      let xml_dict = {};
      for (let child of XML.children) {
        let name = child.getAttribute("Name");
        let type = child.getAttribute("Type");
        if (child.hasChildNodes() && type === "List") {
          let innerItems;
          // Javascript can't really do nice recursive functions...
          // special cases for "History" and "ArticleIds" which has unique inner Names
          if (name === "ArticleIds" || name === "History") {
            let innerDict = {};
            for (c of child.children) {
              innerDict[c.getAttribute("Name")] = c.textContent;
            }
            innerItems = innerDict;
          } else {
            let innerList = [];
            for (c of child.children) {
              innerList.push(c.textContent);
            }
            innerItems = innerList;
          }
          xml_dict[name] = innerItems
        } else if (child.tagName === "Item") {
          // Here just get the inner strings
          xml_dict[name] = child.textContent;
        } else if (child.tagName === "Id") {
          // Special case
          xml_dict["Id"] = child.textContent;
        } else {
          if (!xml_dict["no_key"]) {
            xml_dict["no_key"] = [child.textContent]
          } else {
            xml_dict["no_key"].push(child.textContent)
          }
        }
      }
      return xml_dict;
    }

    // Modify link hover text
    function setPMIDlinkTitle(pmid, link_tag) {
      let pubmed_xml_promise = getPubMedMETAxmlByPMID(pmid);
      pubmed_xml_promise.then(responseXML => {
        const docsum_xml = responseXML.getElementsByTagName('DocSum')[0];
        const pmd = pmidXML2dict(docsum_xml);
        const nAuthors = pmd.AuthorList.length;
        let authorsStr;
        if (nAuthors > 3)
          authorsStr = `${pmd.AuthorList[0]}, ... ${pmc.AuthorList[nAuthors - 1]}`;
        else
          authorsStr = pmd.AuthorList.join(", ");

        // Shortened journal name is in .Source, while full name is in .FullJournalName
        link_tag.title = `${authorsStr}, "${pmd.Title}", ${pmd.Source}, ${pmd.SO}`;
      })
    }

    // Loop all pmid link nodes and set title
    function populatePMIDlinkTitles() {
      let pmid_link_array = document.getElementsByClassName("pmid_link");
      for (link_obj of pmid_link_array) {
        pmid = link_obj.textContent;
        setPMIDlinkTitle(pmid, link_obj)
      }
    }

    // Expand/collapse all
    function expandCollapseAll() {
      let expColBtn = document.getElementById('expand-collapse-all');
      let setCss = '';

      // Expand all; set ALL_COLLAPSED = false;
      if (ALL_COLLAPSED) {
        setCss = 'display: block;';
        ALL_COLLAPSED = false;
        expColBtn.textContent = 'Collapse All';
        // Collapse all; set ALL_COLLAPSED = true;
      } else {
        setCss = 'display: none;';
        ALL_COLLAPSED = true;
        expColBtn.textContent = 'Expand All';
      }

      // Loop all tags
      for (tag of document.getElementsByClassName('group')) {
        tag.style.cssText = setCss
      }
    }
  </script>
  <style>
    {% for category, data in source_colors.items() %}
      {% for source, font_color in data['sources'].items() %}
        .source-{{ source }} {
          background-color: {{ font_color }};
          color: {{ data['color'] }};
        }
      {% endfor %}
    {% endfor %}

    .badge-source {
      margin: 2px;
      float: right;
    }

    .statements-header {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 10;
        padding-top: 5px;
    }
  </style>
{% endblock %}


{% macro badges(src_counts) -%}
  {% if src_counts %}
    {% for color_dict in source_colors.values() %}
      {% if loop.index0 > 0 %}
        <span class="badge badge-source">|</span>
      {% endif %}
      {% for src in color_dict['sources'].keys() %}
        {% if src_counts.get(src) %}
          <span class="badge badge-source source-{{ src }}"
              title="{{ src }}">
      {{ src_counts.get(src) }}
      </span>
        {% endif %}
      {% endfor %}
    {% endfor %}
  {% endif %}
{%- endmacro %}

{% block header_desc %}
  This page allows you to curate the loaded statements. For more information
  please see the
  <a href="https://indra.readthedocs.io/en/latest/tutorials/html_curation.html"
     target="_blank">manual</a>.
{% endblock %}

{% block body %}
    <div class="statements-header">
      <h3>
        <span {% if metadata %}
            title="{% for name, value in metadata.items() %}{{ name }}: {{ value }}
{% endfor %}"
              {% endif %}>
            Statements
        </span>
          <button id="expand-collapse-all" type="button"
                  class="btn btn-primary float-right"
                  onclick="expandCollapseAll()">Expand All
          </button>
      </h3>
      <h6>databases<span class="badge-source">readers</span>{{ badges(source_key_dict) }}</h6>
      <hr>
    </div>
  {% for results in stmt_data.values() %}
    {% if stmt_data.values()|length > 1 %}
      <div class="super_group_heading"
         id="tl-{{ results['html_key'] }}"
         onclick="toggler('tl-{{ results['html_key'] }}')">
        <h5 class="align-middle">
          {{ results['label'] }}{{ badges(results['source_counts']) }}</h5>
      </div>
      <div class="group" id="tl-{{ results['html_key'] }}_group">
    {% else %}
      <div class="group-shown" id="tl-{{ results['html_key'] }}_group">
    {% endif %}
    {% for short_name, short_name_key, stmt_info_list, src_counts in results['stmts_formatted'] %}
      {% if results['stmts_formatted']|length > 1 %}
        <div class="group_heading"
           onclick="toggler('{{ short_name_key }}');"
           id="{{ short_name_key }}_heading">
          <h5 class="align-middle">
            {{ short_name }}{{ badges(src_counts) }}</h5>
        </div>
        <div class="group" id="{{ short_name_key }}_group">
      {% else %}
        <div class="group-shown" id="{{ short_name_key }}_group">
      {% endif %}
    {% for stmt_info in stmt_info_list %}
      <a name="{{ stmt_info['hash'] }}"></a>
      <div class="statement">
        <h5 class="align-middle">
          {{ stmt_info['english'] }}
          <a href="{{ db_rest_url }}/from_hash/{{ stmt_info['hash'] }}?format=html"
             target="_blank">
            <small class="badge badge-secondary badge-pill">{{ stmt_info['evidence_count'] }}</small>
          </a>
          {{ badges(stmt_info['source_count']) }}
        </h5>
      </div>
      <div class="evidence">
        <table class="table"
             id="{{ stmt_info['hash'] }}"
             style="border-collapse: collapse;">
          <tbody id="table_{{ loop.index0 }}">
          {% for ev in stmt_info['evidence'] %}
            <tr id="{{ ev['source_hash'] }}"
              style="border-bottom: 1px solid #FFFFFF;">

              <td width="6em"
                id="row{{ loop.index0 }}_click"
                data-clicked="false"
                class="curation_toggle"
                style="display: none">
                &#9998;
              </td>

              <td width="25em">{{ ev['source_api'] }}</td>
              {% if ev['text'] %}
                <td width="100%">"{{ ev['text'] }}"</td>
              {% else %}
                <td width="100%"><i>None evidence text available</i></td>
              {% endif %}
              <td width="25em" align="left"
                style="white-space: nowrap">
                {% if ev['pmid'] %}
                  <a class="pmid_link"
                     title="Hover again to see info"
                     onmouseover="setPMIDlinkTitle(this.textContent, this); this.onmouseover=null;"
                     href='https://www.ncbi.nlm.nih.gov/pubmed/{{ ev["pmid"] }}'
                     target="_blank">
                    {{ ev['pmid'] }}</a>
                {% elif 'pmid' in ev['text_refs'] and ev['text_refs']['pmid'] %}
                  <a class="pmid_link"
                     title="Hover again to see info"
                     onmouseover="setPMIDlinkTitle(this.textContent, this); this.onmouseover=null;"
                     href='https://www.ncbi.nlm.nih.gov/pubmed/{{ ev["text_refs"]["pmid"] }}'
                     target="_blank">
                    {{ ev['text_refs']['pmid'] }}</a>
                {% endif %}
                {% if 'pmcid' in ev['text_refs'] and ev['text_refs']['pmcid'] %}
                  | <a class="pmcid_link"
                     href='https://www.ncbi.nlm.nih.gov/pmc/articles/{{ ev["text_refs"]["pmcid"] }}'
                     target="_blank">PMC</a>
                {% endif %}
                {% if 'doi' in ev['text_refs'] and ev['text_refs']['doi'] %}
                  | <a class="doi_link"
                     href='https://dx.doi.org/{{ ev["text_refs"]["doi"] }}'
                     target="_blank">DOI</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div> <!-- evidence -->
    {% endfor %}
    </div> <!-- statement group presentation -->
    {% endfor %}
  </div>
  {% endfor %}

{% endblock %}

