<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>INDRA DB Query Results</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script>
        // Check the API key input
        function keySubmit (key_value) {
            var ensure_user = document.getElementById("ensure_user_on_api_key")
            // Default value still there or nothing entered 
            if (key_value == "No key given." | !key_value) {
                return;
            // something entered that is not default value
            } else {
                console.log("document.getElementById(\"api_key_input\").value: " + document.getElementById("api_key_input").value);
                ensure_user.textContent = "Key stored: " + key_value;
            }
        }

        // get a pubmed xml based on a pmid
        function getPubMedMETAxmlByPMID(pmid) {
            var pubmed_fetch = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi";
            params_dict = {'db': 'pubmed',
                'retmode': 'xml',
                'rettype': 'docsum',
                'id': pmid
            };
            PubMedMETAxml = $.ajax({
                url: pubmed_fetch,
                type: "POST",
                dataType: "xml",
                data: params_dict,
            });
            return PubMedMETAxml
        };

        // Get a dictionary from pubmed xml
        function pmidXML2dict(XML) {
            xml_dict = {};
            for (child of XML.children) {
                name = child.getAttribute("Name");
                type = child.getAttribute("Type");
                if (child.hasChildNodes() & type == "List") {
                    // Javascript can't really do nice recursive functions...
                    // special cases for "History" and "ArticleIds" which has unique inner Names
                    if (name == "ArticleIds" | name == "History") {
                        innerDict = {};
                        for (c of child.children) {
                            innerDict[c.getAttribute("Name")] = c.textContent;
                        }
                        innerItems = innerDict;
                    } else {
                        innerList = [];
                        for (c of child.children) {
                            innerList.push(c.textContent);
                        }
                        innerItems = innerList;
                    }
                    xml_dict[name] = innerItems
                } else if (child.tagName == "Item") {
                    // Here just get the inner strings
                    xml_dict[name] = child.textContent;
                } else if (child.tagName == "Id") {
                    // Special case
                    xml_dict["Id"] = child.textContent;
                } else {
                    if (!xml_dict["no_key"]) {
                        xml_dict["no_key"] = [child.textContent]
                    } else {
                        xml_dict["no_key"].push(child.textContent)
                    }
                }
            }
            return xml_dict;
        }

        // Modify link hover text
        function setPMIDlinkTitle(pmid, link_tag) {
            let pubmed_xml_promise = getPubMedMETAxmlByPMID(pmid);
            pubmed_xml_promise.then(function(responseXML) {
                docsum_XML = docsum_xml = responseXML.getElementsByTagName('DocSum')[0];
                pmid_meta_dict = pmidXML2dict(docsum_xml);
                authorlist = pmid_meta_dict.AuthorList
                if (authorlist.length > 3) {
                    authors = authorlist[0] + ", ... " + authorlist[authorlist.length-1];
                } else {
                    authors = authorlist.join(", ");
                }
                // Shortened journal name is in .Source, while full name is in .FullJournalName
                journal = pmid_meta_dict.Source
                SO = pmid_meta_dict.SO
                title = pmid_meta_dict.Title

                pmid_hover_string = authors + ", \"" + title + "\", " + journal + ", " + SO
                link_tag.title = pmid_hover_string;
            })
        }

        function populatePMIDlinkTitles () {
            var pmid_link_array = document.getElementsByClassName("pmid_link");
            for (link_obj of pmid_link_array) {
                pmid = link_obj.textContent;
                setPMIDlinkTitle(pmid, link_obj)
            }
        }

        var readyStateCheckInterval = setInterval(function() {
            // options are "loading", "interactive", "complete"
            if (document.readyState === "complete") {
                clearInterval(readyStateCheckInterval);
                populatePMIDlinkTitles();
            }
        }, 1000); // Time interval in milliseconds

        // Expand/collapse row
        $(function() {
            $("td[class='curation_toggle']").click(function(event) {
                event.stopPropagation();
                var $target = $(event.target);
                if (event.target.dataset.clicked == "true") {
                    // Toggle (animation duration in msec)
                    $target.closest("tr").next().find("div").slideToggle(200);
                // First click event
                } else {
                    // Stay down (animation duration in msec)
                    $target.closest("tr").next().find("div").slideDown(400);

                    // Change color of icon to light gray
                    event.target.style="color:#A4A4A4;"

                    // Set clicked to true
                    event.target.dataset.clicked = "true"
                }
            });
        });

        function submitButtonClick(clickEvent) {
            // CURATOR
            curator = document.getElementById("curator_input").value;
            if (!curator) {
                alert("Please enter a curator ID");
                return;
            }

            api_key = document.getElementById("api_key_input").value;
            if (!api_key) {
                alert("Please enter an API key!");
                return;
            }

            // Get mouseclick target, then parent's parent
            pn = clickEvent.target.parentNode.parentNode;
            btn_row_tag = pn.closest('tr');
            s = pn.getElementsByClassName("dropdown")[0]
                .getElementsByTagName("select")[0]

            // DROPDOWN SELECTION
            err_select = s.options[s.selectedIndex].value;
            if (!err_select) {
                alert('Please select an error type or "correct" for the statement in the dropdown menu');
                return;
            }

            // TEXT BOX CONTENT
            // Get "form" node, then the value of "input"
            user_text = pn
                        .getElementsByClassName("form")[0]
                        .getElementsByTagName("input")[0]
                        .value;

            // GET REFERENCE TO STATUS BOX (EMPTY UNTIL STATUS RECEIVED)
            var statusBox = pn.getElementsByClassName("submission_status")[0].children[0];

            // Step back to the preceding tr tag
            pmid_row = btn_row_tag.previousElementSibling;

            // PMID
            // Get pmid_linktext content
            pmid_text = pmid_row
                        .getElementsByClassName("pmid_link")[0]
                        .textContent.trim()

            // Icon 
            var icon = pmid_row.getElementsByClassName("curation_toggle")[0]

            // HASHES: source_hash & stmt_hash
            // source_hash == ev['source_hash'] == pmid_row.id; "evidence level"
            source_hash = pmid_row.id;
            // stmt_hash == hash == stmt_info['hash'] == table ID; "(pa-) statement level"
            stmt_hash = pmid_row.parentElement.parentElement.id;

            // CURATION DICT
            // example: curation_dict = {'tag': 'Reading', 'text': '"3200 A" is picked up as an agent.', 'curator': 'Klas', 'ev_hash': ev_hash};
            cur_dict = {
                        'tag': err_select, 
                        'text': user_text, 
                        'curator': curator,
                        'ev_hash': source_hash
                    };

            // console.log("User: " + curator);
            // console.log("source hash: " + source_hash)
            // console.log("stmt hash: " + stmt_hash)
            // console.log("Error selected: " + err_select);
            // console.log("User feedback: " + user_text);
            // console.log("PMID: " + pmid_text);
            // console.log("cur_dict");
            // console.log(cur_dict);

            testing = false; // Set to true to test the curation endpoint of the API
            ajx_response = submitCuration(cur_dict, stmt_hash, statusBox, icon, testing);
            console.log("ajax response from submission: ");
            console.log(ajx_response);
        };

        // Submit curation
        function submitCuration(curation_dict, hash, statusBox, icon, test) {
            // API KEY FOR ACCESSING DATABASE
            var api_key = document.getElementById("api_key_input").value;
            curation_addr = "https://lsm6zea7gg.execute-api.us-east-1.amazonaws.com/production/curation/submit/";
            
            _url = curation_addr + hash + "?api_key=" + api_key;

            if (test) {
                console.log("Submitting test curation...");
                _url += "&test";
            };
            
            console.log("api key: " + api_key)
            console.log("url: " + _url);

            response = $.ajax({
                url: _url,
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(curation_dict),
                complete: function(xhr, statusText) {
                    switch (xhr.status) {
                        case 200:
                            statusBox.textContent = "Curation submitted successfully!";
                            icon.style = "color: #00FF00" // Brightest green
                            break;
                        case 400:
                            statusBox.textContent = xhr.status + ": Bad Curation Data";
                            icon.style = "color: #FF0000"; // Super red
                            break;
                        case 404:
                            statusBox.textContent = xhr.status + ": Bad Link";
                            icon.style = "color: #FF0000";
                            break;
                        case 500:
                            statusBox.textContent = xhr.status + ": Internal Server Error";
                            icon.style = "color: #FF0000";
                            break;
                        case 504:
                            statusBox.textContent = xhr.status + ": Server Timeout";
                            icon.style = "color: #58D3F7"; // Icy blue
                            break;
                        default:
                            console.log("Uncaught submission error: check ajax response")
                            console.log("xhr: ")
                            console.log(xhr)
                            statusBox.textContent = "Uncaught submission error; Code " + xhr.status;
                            icon.style = "color: #FF8000"; // Warning orange
                            break;
                    }
                }
            });

            return response;
        };

        // Creates the dropdown div with the following structure
        // <div class="dropdown" 
        //      style="display:inline-block; vertical-align: middle;">
        //     <select>
        //         <option value="" selected disabled hidden>
        //             Select error type...
        //         </option>
        //         <option value="correct">No Error</option>
        //         <option value="grounding">Grounding</option>
        //         <option value="polarity">Polarity</option>
        //         <option value="relation">Relation</option>
        //         <option value="negative_result">Negative Result</option>
        //         <option value="hypothesis">Hypothesis</option>
        //         <option value="other">Other...</option>
        //     </select>
        // </div>
        function createDDDiv () {
            var ddContainer = document.createElement("div")
            ddContainer.className = "dropdown"
            ddContainer.style = "display:inline-block; vertical-align: middle; margin-left: 9%;"

            let ddSelect = document.createElement("select");

            // DROPDOWN OPTIONS
            // Default; This is the option placeholder
            placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.selected = "selected";
            placeholderOption.disabled = "disabled";
            placeholderOption.hidden = "hidden";
            placeholderOption.textContent = "Select error type..."
            ddSelect.appendChild(placeholderOption);
            // 1 "correct" No Error;
            option1 = document.createElement("option");
            option1.value = "correct";
            option1.textContent = "Correct";
            ddSelect.appendChild(option1);
            // 2 "grounding" Grounding;
            option2 = document.createElement("option");
            option2.value = "grounding";
            option2.textContent = "Grounding";
            ddSelect.appendChild(option2);
            // 3 "polarity" Polarity;
            option3 = document.createElement("option");
            option3.value = "polarity";
            option3.textContent = "Polarity";
            ddSelect.appendChild(option3);
            // 4 "relation" Relation;
            option4 = document.createElement("option");
            option4.value = "relation";
            option4.textContent = "Relation";
            ddSelect.appendChild(option4);
            // 5 "negative_result" Negative Result;
            option5 = document.createElement("option");
            option5.value = "negative_result";
            option5.textContent = "Negative Result";
            ddSelect.appendChild(option5);
            // 6 "hypothesis" Hypothesis;
            option6 = document.createElement("option");
            option6.value = "hypothesis";
            option6.textContent = "Hypothesis";
            ddSelect.appendChild(option6);
            // 7 "other" Other...
            option7 = document.createElement("option");
            option7.value = "other";
            option7.textContent = "Other...";
            ddSelect.appendChild(option7);

            // Add more options by following the structure above

            ddContainer.appendChild(ddSelect);

            return ddContainer;
        };

        // Creates the text box div with the following structure:
        // <div class="form" 
        //      style="display:inline-block; 
        //             vertical-align: middle; 
        //             top: 0px">
        //     <form name="user_feedback_form">
        //         <input type="text" 
        //                maxlength="240"
        //                name="user_feedback" 
        //                placeholder="Optional description (240 chars)" 
        //                value=""
        //                style="width: 360px;">
        //     </form>
        // </div>
        function createTBDiv () {
            var tbContainer = document.createElement("div")
            tbContainer.className = "form"
            tbContainer.style = "display:inline-block; vertical-align: middle; margin-left: 4%;"

            let tbForm = document.createElement("form")
            tbForm.name = "user_feedback_form"

            let tbInput = document.createElement("input")
            tbInput.type = "text";
            tbInput.maxlength = "240"
            tbInput.name = "user_feedback";
            tbInput.placeholder = "Optional description (240 chars)";
            tbInput.value = "";
            tbInput.style = "width: 360px;"

            tbForm.appendChild(tbInput);

            tbContainer.appendChild(tbForm);

            return tbContainer;
        };

        // Creates the submit button div with the following structure
        // <div class="curation_button"
        //      style="display:inline-block; 
        //             vertical-align: middle;">
        //     <button
        //         type="button"
        //         class="btn btn-default btn-submit pull-right"
        //         style="padding: 2px 6px">Submit
        //     </button>
        //     < script tag type="text/javascript">
        //     $(".btn-submit").off("click").on("click", function(b){
        //         // Get parent node
        //         parent_node = b.target.parentNode.parentNode
        //         // Get reference to closest row tag (jquery)
        //         this_row = $(this).closest("tr")
        //         submitButtonClick(clickEvent)
        //     })
        //     </ script tag>
        // </div>
        function createSBDiv () {
            var sbContainer = document.createElement("div");
            sbContainer.className = "curation_button";
            sbContainer.style = "display:inline-block; vertical-align: middle; margin-left: 4%;";

            let sbButton = document.createElement("button");
            sbButton.type = "button";
            sbButton.className = "btn btn-default btn-submit pull-right";
            sbButton.style = "padding: 2px 6px";
            sbButton.textContent = "Submit";
            sbButton.onclick = submitButtonClick; // ATTACHES SCRIPT TO BUTTON

            sbContainer.appendChild(sbButton);

            return sbContainer;
        };

        // Creates the textbox that tells the user the status of the submission
        // <div class="submission_status"
        //      style="display:inline-block; 
        //             vertical-align: middle;">
        // <a class="submission_status"></a>
        // </div>
        function createStatusDiv () {
            var statusContainer = document.createElement("div");
            statusContainer.className = "submission_status";
            statusContainer.style = "display:inline-block; vertical-align: middle; margin-left: 4%;";
            
            let textContainer = document.createElement("i");
            textContainer.textContent = "";

            statusContainer.appendChild(textContainer);

            return statusContainer;

        }

        // Append row to the row that executed the click
        // <tr class="cchild" style="border-top: 1px solid #FFFFFF;">
        // <td colspan="4" style="padding: 0px; border-top: 1px solid #FFFFFF;">
        function curationRowGenerator() {
            // Create new row element
            var newRow = document.createElement('tr');
            newRow.innerHTML = null;
            newRow.className = "cchild";
            newRow.style = "border-top: 1px solid #FFFFFF;";

            // Create new td element
            let newTD = document.createElement('td');
            newTD.style="padding: 0px; border-top: 1px solid #FFFFFF; white-space: nowrap; text-align: left;";
            newTD.setAttribute("colspan", "4");

            // Add dropdown div
            var dropdownDiv = createDDDiv();
            newTD.appendChild(dropdownDiv);
            // Add textbox 
            var textBoxDiv = createTBDiv();
            newTD.appendChild(textBoxDiv);
            // Add submit button
            var buttonDiv = createSBDiv();
            newTD.appendChild(buttonDiv);
            // Add submission response textbox
            var statusDiv = createStatusDiv();
            newTD.appendChild(statusDiv);

            // Add td to table row
            newRow.appendChild(newTD);

            return newRow;
        };

        // Adds the curation row to current
        function addCurationRow(clickedRow) {
            // Generate new row
            var curationRow = curationRowGenerator();

            // Append new row to provided row
            clickedRow.parentNode.insertBefore(curationRow, clickedRow.nextSibling);
        };

    </script>
    <!-- /KLAS USER SCRIPTS -->

  <style>
.label-subject {
  background-color: #4a36aa;
}
.label-object {
  background-color: #2d8e4c;
}
.label-other {
  background-color: #606060;
}
  </style>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">INDRA DB Query Results</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
         <!--
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li>
          </ul>
           -->
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container theme-showcase" role="main">
        <div>
            <p>&nbsp;
        </div>
        <div class="page-header">
            <a name='index'></a>
            <h4>Curator Information</h4>
            <div class="user_data">
            <div class="api_key_form" id="api_key_form" style="display:inline-block; vertical-align: top; width: 330">
                <form name="apiKeyForm" action="javascript:keySubmit(api_key_input.value)">
                    <b>API key</b><br>If no key is provided your curation will be rejected.<br>
                    <input type="text" name="api_key" id="api_key_input" placeholder="Enter key here..." style="width: 200px;">
                    <input type="submit" name="store_button" value="submit key">
                    <div id="ensure_user_on_api_key">No key given.</div>
                </form>
            </div>
            <div class="curator_form" id="curator_form" style="display:inline-block; vertical-align: top; width: 330">
                <form name="curatorForm">
                    <b>Curator ID</b><br>Your curation will get priority if you provide your email or name.<br>
                    <input type="text" name="curator" id="curator_input" placeholder="Enter your name or email..." style="width: 200px;">
                </form>
            </div>
        </div>
        </div>

    <!--<div class="page-header">
        <h1>Detailed Results</h1>
        <p>Statements are sorted according to amount of evidence.</p>
    </div>-->
    {% for stmt_info in statements %}
    <a name='{{ stmt_info['hash'] }}'></a>
    <div class="statement">
        <h4 class="align-middle">{{ stmt_info['english'] }}
            <a href="./from_hash/{{ stmt_info['hash'] }}?format=html">
                <span class="badge">{{ stmt_info['evidence_count'] }}</span></a>
        </h4>
    </div>
    <div class="evidence">
    <p><a href='#index'>Back to index</a>
    <table class="table" id="{{ stmt_info['hash'] }}" style="border-collapse: collapse;">
            <thead>
              <tr>
                <th></th>
                <th>Source</th>
                <th>Evidence</th>
                <th>Source Refs</th>
              </tr>
            </thead>
            <tbody id="table_{{loop.index0}}">
                {% for ev in stmt_info['evidence'] %}
                <tr class="parent" id="{{ ev['source_hash'] }}" style="border-bottom: 1px solid #FFFFFF;">
                    <td id="row{{loop.index0}}_click" data-clicked="false" class="curation_toggle" onclick="addCurationRow(this.closest('tr')); this.onclick=null;">&#9998;</td>
                    <td>{{ ev['source_api'] }}</td>
                    <td>"{{ ev['text'] }}"</td>
                    <td style="white-space: nowrap">
                        {% if 'pmid' in ev['text_refs'] %}
                        <a class="pmid_link"
                href='https://www.ncbi.nlm.nih.gov/pubmed/{{ ev['text_refs']['pmid'] }}'>
                        {{ ev['text_refs']['pmid'] }}</a>
                       {% endif %}
                       {% if 'pmcid' in ev['text_refs'] and ev['text_refs']['pmcid'] %}
                       | <a class="pmcid_link"
                href='https://www.ncbi.nlm.nih.gov/pmc/articles/{{ ev['text_refs']['pmcid'] }}'>PMC</a>
                        {% endif %}
                       {% if 'doi' in ev['text_refs'] and ev['text_refs']['doi'] %}
                       | <a class="doi_link"
                href='https://dx.doi.org/{{ ev['text_refs']['doi'] }}'>DOI</a>
                       {% endif %}
                    </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
    </div> <!-- evidence -->
    {% endfor %}

    {% if rest_api_results %}
    <div class="page-header">
        <h4>About this result</h4>
    </div>
    <ul>
        <li>Statements returned: {{ rest_api_results['statements_returned'] }}</li>
        <li>Statement limit: {{ rest_api_results['statement_limit'] }}</li>
        <li>Total evidence: {{ rest_api_results['total_evidence'] }}</li>
        <li>Evidence limit: {{ rest_api_results['evidence_limit'] }}</li>
        <li>Evidence returned: {{ rest_api_results['evidence_returned'] }}</li>
        <li>Offset: {{ rest_api_results['offset'] }}</li>
    </ul>
    {% endif %}

    </div> <!-- /container -->
  </body>
</html>

